<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Player | Top 10 songs (Spotify)</title>

  <!-- your existing styles -->
  <link href="https://fonts.googleapis.com/css?family=Bitter:400,700&display=swap&subset=latin-ext" rel="stylesheet" />
  <link rel="stylesheet" href="https://meyerweb.com/eric/tools/css/reset/reset.css" />
  <link rel="stylesheet" href="https://vinnyy.me/css/player.css" />
  <link rel="icon" href="https://vinnyy.me/img/logo-i.png">
  <link rel="apple-touch-icon" href="https://cdn.vinnyy.me/logo-i.png">
  <meta property="og:title" content="Media player">
  <meta property="og:description" content="Top 10 Spotify tracks">
  <meta name="theme-color" content="#1DB954">
  <meta name="application-name" content="Top 10 songs media player">
  <meta name="twitter:card" content="summary_large_image">
  <style>
    [v-cloak]{display:none}
    .hint { text-align:center; font-size:12px; opacity:.8; margin-top:8px; }
    .btn { padding:8px 14px; border-radius:10px; border:1px solid #2e2e2e33; cursor:pointer }
  </style>
</head>

<body>
  <div class="wrapper" id="app">
    <div class="player" v-cloak>
      <div class="player__top">
        <div class="player-cover">
          <transition-group :name="transitionName">
            <div
              class="player-cover__item"
              v-for="(track, $index) in tracks"
              :key="track.id"
              v-if="$index === currentTrackIndex"
              :style="{ backgroundImage: `url(${track.cover})` }">
            </div>
          </transition-group>
        </div>

        <div class="player-controls">
          <div class="player-controls__item -favorite"
               :class="{ active : currentTrack.favorited }"
               @click="toggleFavorite"
               title="(Demo) Toggle Favorite">
            <svg class="icon"><use xlink:href="#icon-heart-o"></use></svg>
          </div>

          <a :href="currentTrack.url" target="_blank" class="player-controls__item" title="Open in Spotify">
            <svg class="icon"><use xlink:href="#icon-link"></use></svg>
          </a>

          <div class="player-controls__item" @click="prevTrack" title="Previous">
            <svg class="icon"><use xlink:href="#icon-prev"></use></svg>
          </div>

          <div class="player-controls__item" @click="nextTrack" title="Next">
            <svg class="icon"><use xlink:href="#icon-next"></use></svg>
          </div>

          <div class="player-controls__item -xl js-play"
               @click="togglePlay"
               :title="isPlaying ? 'Pause' : 'Play'">
            <svg class="icon">
              <use xlink:href="#icon-pause" v-if="isPlaying"></use>
              <use xlink:href="#icon-play" v-else></use>
            </svg>
          </div>
        </div>
      </div>

      <div class="progress" ref="progress">
        <div class="progress__top">
          <div class="album-info" v-if="currentTrack">
            <div class="album-info__name">{{ currentTrack.artist }}</div>
            <div class="album-info__track">{{ currentTrack.name }}</div>
          </div>
          <div class="progress__duration">{{ duration }}</div>
        </div>
        <div class="progress__bar" @click="seek">
          <div class="progress__current" :style="{ width : barWidth }"></div>
        </div>
        <div class="progress__time">{{ currentTime }}</div>
      </div>

      <div style="margin-top:14px; text-align:center;">
        <button v-if="!accessToken" class="btn" @click="login">Connect Spotify</button>

        <select v-model="timeRange" @change="loadTopTracks" style="margin-left:8px;">
          <option value="short_term">Top 10 (last 4 weeks)</option>
          <option value="medium_term">Top 10 (6 months)</option>
          <option value="long_term">Top 10 (all time)</option>
        </select>

        <div class="hint" v-if="accessToken && !isPremium">
          In-browser playback requires Spotify Premium. Play button will open tracks in Spotify.
        </div>
      </div>
    </div>
  </div>

  <!-- Keep your SVG icon <defs> exactly as in your original file -->
  <!-- Paste your <svg><defs>… icons …</defs></svg> block here -->
  <!-- (omitted for brevity) -->

  <!-- Vue 2 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
  <!-- Spotify Web Playback SDK -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <script>
    /***** CONFIG *****/
    const SPOTIFY_CLIENT_ID = "PUT_YOUR_SPOTIFY_CLIENT_ID_HERE"; // <— REQUIRED
    const REDIRECT_URI = window.location.origin + window.location.pathname; // this page
    const SCOPES = [
      "user-read-email",
      "user-top-read",
      "user-read-playback-state",
      "user-modify-playback-state",
      "streaming"
    ].join(" ");
    /*******************/

    function authUrl() {
      const p = new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID,
        response_type: "token",
        redirect_uri: REDIRECT_URI,
        scope: SCOPES,
        show_dialog: "true",
        state: Math.random().toString(36).slice(2)
      });
      return `https://accounts.spotify.com/authorize?${p.toString()}`;
    }

    function parseAndStoreToken() {
      const hash = new URLSearchParams(window.location.hash.slice(1));
      const token = hash.get("access_token");
      const expiresIn = parseInt(hash.get("expires_in") || "0", 10);
      if (token) {
        localStorage.setItem("sp_access_token", token);
        if (expiresIn) {
          const expAt = Date.now() + (expiresIn - 30) * 1000;
          localStorage.setItem("sp_expires_at", String(expAt));
        }
        history.replaceState(null, "", window.location.pathname + window.location.search);
      }
    }

    function getStoredToken() {
      const t = localStorage.getItem("sp_access_token");
      const exp = parseInt(localStorage.getItem("sp_expires_at") || "0", 10);
      if (!t || Date.now() > exp) return null;
      return t;
    }

    new Vue({
      el: "#app",
      data() {
        return {
          transitionName: "fade",
          tracks: [],
          currentTrackIndex: 0,
          isPlaying: false,
          duration: "0:00",
          currentTime: "0:00",
          barWidth: "0%",
          accessToken: null,
          isPremium: false,
          deviceId: null,
          player: null,
          timeRange: "short_term"
        };
      },
      computed: {
        currentTrack() {
          return this.tracks[this.currentTrackIndex] || {};
        }
      },
      async created() {
        parseAndStoreToken();
        this.accessToken = getStoredToken();
        if (this.accessToken) {
          await this.bootstrap();
        }
      },
      methods: {
        login() {
          if (!SPOTIFY_CLIENT_ID || SPOTIFY_CLIENT_ID.includes("PUT_YOUR")) {
            alert("Add your Spotify Client ID in the code first.");
            return;
          }
          window.location.href = authUrl();
        },

        async bootstrap() {
          try {
            // whoami (also tells if Premium)
            const me = await this.apiGET("https://api.spotify.com/v1/me");
            this.isPremium = (me.product === "premium");

            // load tracks
            await this.loadTopTracks();

            // set up player if premium
            if (this.isPremium) {
              await this.setupPlayer();
            }
          } catch (e) {
            console.error(e);
            alert("Spotify auth failed or API error. Try reconnecting.");
            this.logout();
          }
        },

        logout() {
          localStorage.removeItem("sp_access_token");
          localStorage.removeItem("sp_expires_at");
          this.accessToken = null;
          this.isPremium = false;
          this.tracks = [];
          this.currentTrackIndex = 0;
          this.isPlaying = false;
        },

        async loadTopTracks() {
          if (!this.accessToken) return;
          const url = `https://api.spotify.com/v1/me/top/tracks?limit=10&time_range=${this.timeRange}`;
          const data = await this.apiGET(url);
          this.tracks = (data.items || []).map(t => ({
            id: t.id,
            name: t.name,
            artist: (t.artists || []).map(a => a.name).join(", "),
            cover: (t.album?.images?.[0]?.url) || "",
            url: t.external_urls?.spotify || "#",
            uri: t.uri
          }));
          this.currentTrackIndex = 0;
          // If premium, preload a queue to your device when available
          if (this.isPremium && this.deviceId) {
            await this.transferAndQueue(this.currentTrackIndex, false);
          }
        },

        formatTime(sec) {
          const s = Math.floor(sec);
          const m = Math.floor(s / 60);
          const r = s % 60;
          return `${m}:${r.toString().padStart(2,"0")}`;
        },

        async setupPlayer() {
          await new Promise(resolve => {
            if (window.Spotify) resolve();
            else window.onSpotifyWebPlaybackSDKReady = resolve;
          });

          this.player = new Spotify.Player({
            name: "Vinny Top 10 Player",
            getOAuthToken: cb => cb(this.accessToken),
            volume: 0.8
          });

          this.player.addListener("ready", async ({ device_id }) => {
            this.deviceId = device_id;
            // transfer playback to this device silently
            await this.apiPUT("https://api.spotify.com/v1/me/player", { device_ids: [device_id], play: false });
            // queue current list
            if (this.tracks.length) await this.transferAndQueue(this.currentTrackIndex, false);
          });

          this.player.addListener("not_ready", ({ device_id }) => {
            if (this.deviceId === device_id) this.deviceId = null;
          });

          this.player.addListener("player_state_changed", s => {
            if (!s) return;
            const { position, duration, paused, track_window } = s;
            this.isPlaying = !paused;
            if (duration) {
              this.barWidth = `${(position / duration) * 100}%`;
              this.currentTime = this.formatTime(position / 1000);
              this.duration = this.formatTime(duration / 1000);
            }
            const currUri = track_window?.current_track?.uri;
            const idx = this.tracks.findIndex(t => t.uri === currUri);
            if (idx >= 0) this.currentTrackIndex = idx;
          });

          const ok = await this.player.connect();
          if (!ok) console.warn("Player connection failed");
        },

        async togglePlay() {
          if (!this.tracks.length) return;
          // If not premium, open the track in Spotify
          if (!this.isPremium || !this.player || !this.deviceId) {
            window.open(this.currentTrack.url, "_blank");
            return;
          }
          // Start playback if stopped, otherwise toggle
          try {
            const state = await this.player.getCurrentState();
            if (!state || state.paused) {
              await this.transferAndQueue(this.currentTrackIndex, true);
            } else {
              await this.player.togglePlay();
            }
          } catch (e) {
            console.error(e);
          }
        },

        async nextTrack() {
          if (!this.tracks.length) return;
          const next = (this.currentTrackIndex + 1) % this.tracks.length;
          await this.playIndex(next);
        },

        async prevTrack() {
          if (!this.tracks.length) return;
          const prev = (this.currentTrackIndex - 1 + this.tracks.length) % this.tracks.length;
          await this.playIndex(prev);
        },

        async playIndex(index) {
          this.currentTrackIndex = index;
          if (!this.isPremium || !this.player || !this.deviceId) {
            window.open(this.tracks[index].url, "_blank");
            return;
          }
          await this.transferAndQueue(index, true);
        },

        async transferAndQueue(index, autoplay) {
          // Set the whole list as the context using URIs, start at index
          const uris = this.tracks.map(t => t.uri);
          await this.apiPUT(`https://api.spotify.com/v1/me/player/play?device_id=${this.deviceId}`, {
            uris,
            offset: { position: index }
          });
          if (!autoplay) {
            // pause immediately if we don't want auto-play
            await this.player.pause();
          }
        },

        async seek(e) {
          if (!this.player) return;
          const bar = this.$refs.progress.querySelector(".progress__bar");
          const rect = bar.getBoundingClientRect();
          const pct = Math.min(Math.max((e.clientX - rect.left) / rect.width, 0), 1);
          try {
            const state = await this.player.getCurrentState();
            if (state) {
              const ms = Math.floor(state.duration * pct);
              await this.player.seek(ms);
            }
          } catch (err) {
            console.error(err);
          }
        },

        toggleFavorite() {
          // purely visual in this minimal demo
          if (!this.tracks.length) return;
          const t = this.tracks[this.currentTrackIndex];
          t.favorited = !t.favorited;
          this.$set(this.tracks, this.currentTrackIndex, { ...t });
        },

        async apiGET(url) {
          const r = await fetch(url, { headers: { Authorization: `Bearer ${this.accessToken}` } });
          if (!r.ok) throw new Error(await r.text());
          return r.json();
        },

        async apiPUT(url, body) {
          const r = await fetch(url, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${this.accessToken}`,
              "Content-Type": "application/json"
            },
            body: body ? JSON.stringify(body) : null
          });
          if (!r.ok && r.status !== 204) throw new Error(await r.text());
          return true;
        }
      }
    });
  </script>
</body>
</html>
