<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Player | Top 10 songs (Spotify)</title>

  <!-- base styles -->
  <link href="https://fonts.googleapis.com/css?family=Bitter:400,700&display=swap&subset=latin-ext" rel="stylesheet" />
  <link rel="stylesheet" href="https://meyerweb.com/eric/tools/css/reset/reset.css" />
  <link rel="stylesheet" href="https://vinnyy.me/css/player.css" />
  <link rel="icon" href="https://vinnyy.me/img/logo-i.png">
  <link rel="apple-touch-icon" href="https://cdn.vinnyy.me/logo-i.png">
  <meta property="og:title" content="Media player">
  <meta property="og:description" content="Top 10 Spotify tracks">
  <meta name="theme-color" content="#1DB954">
  <meta name="application-name" content="Top 10 songs media player">
  <meta name="twitter:card" content="summary_large_image">

  <!-- theme tweaks for buttons/select to match your palette -->
  <style>
    [v-cloak]{display:none}
    :root{
      --mint-700:#396f67;
      --mint-500:#6fa79d;
      --mint-300:#9fc9c0;
      --card:#f5f2cf;
      --ring:rgba(111,167,157,.45);
      --shadow:0 8px 24px rgba(0,0,0,.12), 0 2px 6px rgba(0,0,0,.06);
      --shadow-pressed:0 4px 12px rgba(0,0,0,.18), 0 1px 4px rgba(0,0,0,.08);
    }
    .ui-row{
      margin-top:14px; display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn.theme{
      -webkit-appearance:none; appearance:none; border:none; border-radius:9999px;
      padding:10px 16px; font-weight:600; letter-spacing:.2px;
      background:linear-gradient(180deg, var(--card), #efeabf); color:var(--mint-700);
      box-shadow:var(--shadow); cursor:pointer; transition:transform .08s, box-shadow .15s, background .2s;
      outline:2px solid transparent; outline-offset:2px;
    }
    .btn.theme:hover{ background:linear-gradient(180deg, #faf6d9, #ece6b9); }
    .btn.theme:active{ transform:translateY(1px); box-shadow:var(--shadow-pressed); }
    .btn.theme:focus-visible{ box-shadow:0 0 0 6px var(--ring), var(--shadow); }

    .select.theme{ position:relative; display:inline-flex; align-items:center; box-shadow:var(--shadow);
      border-radius:9999px; overflow:hidden; background:linear-gradient(180deg, var(--card), #efeabf);
    }
    .select.theme select{
      -webkit-appearance:none; appearance:none; border:none; background:transparent;
      padding:10px 38px 10px 14px; font-weight:600; color:var(--mint-700); cursor:pointer; outline:none;
    }
    .select.theme::after{
      content:""; position:absolute; right:12px; width:14px; height:14px; pointer-events:none;
      background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 20 20" fill="none" stroke="%23396f67" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 8 10 13 15 8"/></svg>') center/14px 14px no-repeat; opacity:.9;
    }

    .player-controls__item .icon{ fill:var(--mint-700); opacity:.9; }
    .player-controls__item:hover .icon{ opacity:1; }
    .progress__bar{ background:rgba(57,111,103,.18); }
    .progress__current{ background:var(--mint-500); }
    .player-controls__item.-xl{
      background:linear-gradient(180deg, var(--card), #ece6b9) !important;
      box-shadow:var(--shadow) !important; border:2px solid var(--mint-300) !important;
    }
    .hint { text-align:center; font-size:12px; opacity:.85; margin-top:6px; }
    .status { text-align:center; font-size:12px; opacity:.9; margin-top:8px; }
  </style>
</head>

<body>
  <div class="wrapper" id="app">
    <div class="player" v-cloak>
      <div class="player__top">
        <div class="player-cover">
          <transition-group :name="transitionName">
            <div class="player-cover__item"
                 v-for="(track, $index) in tracks"
                 :key="track.id"
                 v-if="$index === currentTrackIndex"
                 :style="{ backgroundImage: `url(${track.cover})` }"></div>
          </transition-group>
        </div>

        <div class="player-controls">
          <div class="player-controls__item -favorite"
               :class="{ active : currentTrack.favorited }"
               @click="toggleFavorite" title="Favorite (visual)">
            <svg class="icon"><use xlink:href="#icon-heart-o"></use></svg>
          </div>

          <a :href="currentTrack.url" target="_blank" class="player-controls__item" title="Open in Spotify">
            <svg class="icon"><use xlink:href="#icon-link"></use></svg>
          </a>

          <div class="player-controls__item" @click="prevTrack" title="Previous">
            <svg class="icon"><use xlink:href="#icon-prev"></use></svg>
          </div>

          <div class="player-controls__item" @click="nextTrack" title="Next">
            <svg class="icon"><use xlink:href="#icon-next"></use></svg>
          </div>

          <div class="player-controls__item -xl js-play"
               @click="togglePlay"
               :title="isPlaying ? 'Pause' : 'Play'">
            <svg class="icon">
              <use xlink:href="#icon-pause" v-if="isPlaying"></use>
              <use xlink:href="#icon-play" v-else></use>
            </svg>
          </div>
        </div>
      </div>

      <div class="progress" ref="progress">
        <div class="progress__top">
          <div class="album-info" v-if="currentTrack">
            <div class="album-info__name">{{ currentTrack.artist }}</div>
            <div class="album-info__track">{{ currentTrack.name }}</div>
          </div>
          <div class="progress__duration">{{ duration }}</div>
        </div>
        <div class="progress__bar" @click="seek">
          <div class="progress__current" :style="{ width : barWidth }"></div>
        </div>
        <div class="progress__time">{{ currentTime }}</div>
      </div>

      <div class="ui-row">
        <button v-if="!accessToken" class="btn theme" @click="login">Connect Spotify</button>
        <span class="select theme">
          <select v-model="timeRange" @change="loadTopTracks" aria-label="Top tracks range">
            <option value="short_term">Top 10 (last 4 weeks)</option>
            <option value="medium_term">Top 10 (6 months)</option>
            <option value="long_term">Top 10 (all time)</option>
          </select>
        </span>
      </div>

      <div class="status" v-if="playbackNote">{{ playbackNote }}</div>
    </div>
  </div>

  <!-- SVG ICONS (same set you used originally) -->
  <svg xmlns="http://www.w3.org/2000/svg" hidden xmlns:xlink="http://www.w3.org/1999/xlink">
    <defs>
      <!-- heart outline -->
      <symbol id="icon-heart-o" viewBox="0 0 32 32">
        <path d="M22.88 1.952c-2.72 0-5.184 1.28-6.88 3.456-1.696-2.176-4.16-3.456-6.88-3.456-4.48 0-9.024 3.648-9.024 10.592 0 7.232 7.776 12.704 15.072 17.248 0.256 0.16 0.544 0.256 0.832 0.256s0.576-0.096 0.832-0.256c7.296-4.544 15.072-10.016 15.072-17.248 0-6.944-4.544-10.592-9.024-10.592zM16 26.56c-4.864-3.072-12.736-8.288-12.736-14.016 0-5.088 3.040-7.424 5.824-7.424 2.368 0 4.384 1.504 5.408 4.032 0.256 0.608 0.832 0.992 1.472 0.992s1.248-0.384 1.472-0.992c1.024-2.528 3.040-4.032 5.408-4.032 2.816 0 5.824 2.304 5.824 7.424 0.064 5.728-7.808 10.976-12.672 14.016z"></path>
        <path d="M16 30.144c-0.32 0-0.64-0.096-0.896-0.256-7.296-4.576-15.104-10.048-15.104-17.344 0-7.008 4.576-10.688 9.12-10.688 2.656 0 5.152 1.216 6.88 3.392 1.728-2.144 4.224-3.392 6.88-3.392 4.544 0 9.12 3.68 9.12 10.688 0 7.296-7.808 12.768-15.104 17.344-0.256 0.16-0.576 0.256-0.896 0.256z"></path>
      </symbol>
      <symbol id="icon-pause" viewBox="0 0 32 32">
        <path d="M16 0.32c-8.64 0-15.68 7.040-15.68 15.68s7.040 15.68 15.68 15.68 15.68-7.040 15.68-15.68-7.040-15.68-15.68-15.68zM16 29.216c-7.296 0-13.216-5.92-13.216-13.216s5.92-13.216 13.216-13.216 13.216 5.92 13.216 13.216-5.92 13.216-13.216 13.216z"></path>
        <path d="M12.16 22.336v0c-0.896 0-1.6-0.704-1.6-1.6v-9.472c0-0.896 0.704-1.6 1.6-1.6v0c0.896 0 1.6 0.704 1.6 1.6v9.504c0 0.864-0.704 1.568-1.6 1.568z"></path>
        <path d="M19.84 22.336v0c-0.896 0-1.6-0.704-1.6-1.6v-9.472c0-0.896 0.704-1.6 1.6-1.6v0c0.896 0 1.6 0.704 1.6 1.6v9.504c0 0.864-0.704 1.568-1.6 1.568z"></path>
      </symbol>
      <symbol id="icon-play" viewBox="0 0 32 32">
        <path d="M21.216 15.168l-7.616-5.088c-0.672-0.416-1.504 0.032-1.504 0.832v10.176c0 0.8 0.896 1.248 1.504 0.832l7.616-5.088c0.576-0.416 0.576-1.248 0-1.664z"></path>
        <path d="M16 0.32c-8.64 0-15.68 7.040-15.68 15.68s7.040 15.68 15.68 15.68 15.68-7.040 15.68-15.68-7.040-15.68-15.68-15.68zM16 29.216c-7.296 0-13.216-5.92-13.216-13.216s5.92-13.216 13.216-13.216 13.216 5.92 13.216 13.216-5.92 13.216-13.216 13.216z"></path>
      </symbol>
      <symbol id="icon-link" viewBox="0 0 32 32">
        <path d="M23.584 17.92c0 0.864 0 1.728 0 2.56 0 1.312 0 2.656 0 3.968 0 0.352 0.032 0.736-0.032 1.12 0.032-0.16 0.032-0.288 0.064-0.448-0.032 0.224-0.096 0.448-0.16 0.64 0.064-0.128 0.128-0.256 0.16-0.416-0.096 0.192-0.192 0.384-0.32 0.576 0.096-0.128 0.16-0.224 0.256-0.352-0.128 0.16-0.288 0.32-0.48 0.48 0.128-0.096 0.224-0.16 0.352-0.256-0.192 0.128-0.352 0.256-0.576 0.32 0.128-0.064 0.256-0.128 0.416-0.16-0.224 0.096-0.416 0.16-0.64 0.16 0.16-0.032 0.288-0.032 0.448-0.064-0.256 0.032-0.512 0.032-0.768 0.032-0.448 0-0.896 0-1.312 0-1.472 0-2.976 0-4.448 0-1.824 0-3.616 0-5.44 0-1.568 0-3.104 0-4.672 0-0.736 0-1.44 0-2.176 0-0.128 0-0.224 0-0.352-0.032 0.16 0.032 0.288 0.032 0.448 0.064-0.224-0.032-0.448-0.096-0.64-0.16 0.128 0.064 0.256 0.128 0.416 0.16-0.192-0.096-0.384-0.192-0.576-0.32 0.128 0.096 0.224 0.16 0.352 0.256-0.16-0.128-0.32-0.288-0.48-0.48 0.096 0.128 0.16 0.224 0.256 0.352-0.128-0.192-0.256-0.352-0.32-0.576 0.064 0.128 0.128 0.256 0.16 0.416-0.096-0.224-0.16-0.416-0.16-0.64 0.032 0.16 0.032 0.288 0.064 0.448-0.032-0.256-0.032-0.512-0.032-0.768 0-0.448 0-0.896 0-1.312 0-1.472 0-2.976 0-4.448 0-1.824 0-3.616 0-5.44 0-1.568 0-3.104 0-4.672 0-0.736 0-1.44 0-2.176 0-0.128 0-0.224 0.032-0.352-0.032 0.16-0.032 0.288-0.064 0.448 0.032-0.224 0.096-0.448 0.16-0.64-0.064 0.128-0.128 0.256-0.16 0.416 0.096-0.192 0.192-0.384 0.32-0.576-0.096 0.128-0.16 0.224-0.256 0.352 0.128-0.16 0.288-0.32 0.48-0.48-0.128 0.096-0.224 0.16-0.352 0.256 0.192-0.128 0.352-0.256 0.576-0.32-0.128 0.064-0.256 0.128-0.416 0.16 0.224-0.096 0.416-0.16 0.64-0.16-0.16 0.032-0.288 0.032-0.448 0.064 0.48-0.064 0.96-0.032 1.44-0.032 0.992 0 1.952 0 2.944 0 1.216 0 2.432 0 3.616 0 1.056 0 2.112 0 3.168 0 0.512 0 1.024 0 1.536 0"></path>
      </symbol>
      <symbol id="icon-next" viewBox="0 0 32 32">
        <path d="M2.304 18.304h14.688l-4.608 4.576c-0.864 0.864-0.864 2.336 0 3.232 0.864 0.864 2.336 0.864 3.232 0l8.448-8.48c0.864-0.864 0.864-2.336 0-3.232l-8.448-8.448c-0.448-0.448-1.056-0.672-1.632-0.672s-1.184 0.224-1.632 0.672c-0.864 0.864-0.864 2.336 0 3.232l4.64 4.576h-14.688c-1.248 0-2.304 0.992-2.304 2.272s1.024 2.272 2.304 2.272z"></path>
        <path d="M29.696 26.752c1.248 0 2.304-1.024 2.304-2.304v-16.928c0-1.248-1.024-2.304-2.304-2.304s-2.304 1.024-2.304 2.304v16.928c0.064 1.28 1.056 2.304 2.304 2.304z"></path>
      </symbol>
      <symbol id="icon-prev" viewBox="0 0 32 32">
        <path d="M29.696 13.696h-14.688l4.576-4.576c0.864-0.864 0.864-2.336 0-3.232-0.864-0.864-2.336-0.864-3.232 0l-8.448 8.48c-0.864 0.864-0.864 2.336 0 3.232l8.448 8.448c0.448 0.448 1.056 0.672 1.632 0.672s1.184-0.224 1.632-0.672c0.864-0.864 0.864-2.336 0-3.232l-4.608-4.576h14.688c1.248 0 2.304-1.024 2.304-2.304s-1.024-2.24-2.304-2.24z"></path>
        <path d="M2.304 5.248c-1.248 0-2.304 1.024-2.304 2.304v16.928c0 1.248 1.024 2.304 2.304 2.304s2.304-1.024 2.304-2.304v-16.928c-0.064-1.28-1.056-2.304-2.304-2.304z"></path>
      </symbol>
    </defs>
  </svg>

  <!-- Vue 2 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
  <!-- Spotify Web Playback SDK -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <script>
    /***** CONFIG *****/
    const SPOTIFY_CLIENT_ID = "ac85efebe70c43bfb7dd736f8c440c0e"; // your app
    const REDIRECT_URI = "https://vinnyy.me/player/";             // must match dashboard exactly
    const SCOPES = [
      "user-read-email",
      "user-top-read",
      "user-read-playback-state",
      "user-modify-playback-state",
      "streaming"
    ].join(" ");
    /*******************/

    /* ------------ PKCE helpers (frontend-only) ------------ */
    function b64url(bytes){
      return btoa(String.fromCharCode(...new Uint8Array(bytes))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
    }
    async function sha256(str){
      const data = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return b64url(digest);
    }
    function randString(len=64){
      const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
      let out=""; const arr=crypto.getRandomValues(new Uint8Array(len));
      for(let i=0;i<len;i++) out+=chars[arr[i]%chars.length];
      return out;
    }
    async function startLoginPKCE(){
      const codeVerifier = randString(64);
      const codeChallenge = await sha256(codeVerifier);
      const state = randString(16);
      sessionStorage.setItem("sp_code_verifier", codeVerifier);
      sessionStorage.setItem("sp_state", state);
      const p = new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID,
        response_type: "code",
        redirect_uri: REDIRECT_URI,
        scope: SCOPES,
        code_challenge_method: "S256",
        code_challenge: codeChallenge,
        state
      });
      window.location.href = `https://accounts.spotify.com/authorize?${p.toString()}`;
    }
    async function handleAuthCallbackPKCE(){
      const qs = new URLSearchParams(window.location.search);
      const code = qs.get("code");
      const state = qs.get("state");
      const error = qs.get("error");
      if (error) throw new Error(error);
      if (!code) return null;

      const savedState = sessionStorage.getItem("sp_state");
      if (!state || state !== savedState) throw new Error("State mismatch");
      sessionStorage.removeItem("sp_state");

      const codeVerifier = sessionStorage.getItem("sp_code_verifier");
      if (!codeVerifier) throw new Error("Missing code_verifier");

      const body = new URLSearchParams({
        grant_type: "authorization_code",
        code,
        redirect_uri: REDIRECT_URI,
        client_id: SPOTIFY_CLIENT_ID,
        code_verifier: codeVerifier
      });

      const r = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });
      if (!r.ok) throw new Error(await r.text());
      const data = await r.json();
      storeTokens(data);

      const url = new URL(window.location.href); url.search=""; history.replaceState(null,"",url.toString());
      return data.access_token;
    }
    function storeTokens(data){
      const expiresAt = Date.now() + (data.expires_in - 30) * 1000;
      localStorage.setItem("sp_access_token", data.access_token);
      localStorage.setItem("sp_refresh_token", data.refresh_token || "");
      localStorage.setItem("sp_expires_at", String(expiresAt));
    }
    function getStoredToken(){
      const t = localStorage.getItem("sp_access_token");
      const exp = parseInt(localStorage.getItem("sp_expires_at") || "0", 10);
      if (!t || Date.now() > exp) return null;
      return t;
    }
    async function refreshIfNeeded(){
      const exp = parseInt(localStorage.getItem("sp_expires_at") || "0", 10);
      if (Date.now() < exp) return localStorage.getItem("sp_access_token");
      const refresh_token = localStorage.getItem("sp_refresh_token");
      if (!refresh_token) return null;

      const body = new URLSearchParams({
        grant_type: "refresh_token",
        refresh_token,
        client_id: SPOTIFY_CLIENT_ID
      });
      const r = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body
      });
      if (!r.ok) throw new Error(await r.text());
      const data = await r.json();
      if (!data.refresh_token) data.refresh_token = refresh_token;
      storeTokens(data);
      return data.access_token;
    }

    /* ---------------------- App ---------------------- */
    new Vue({
      el: "#app",
      data(){
        return {
          transitionName:"fade",
          tracks:[],
          currentTrackIndex:0,
          isPlaying:false,
          duration:"0:00",
          currentTime:"0:00",
          barWidth:"0%",
          accessToken:null,
          isPremium:false,
          deviceId:null,
          player:null,
          timeRange:"short_term",
          playbackNote:"",
          sdkSupported: true,
          isMobile: /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
        };
      },
      computed:{
        currentTrack(){ return this.tracks[this.currentTrackIndex] || {}; }
      },
      async created(){
        try { await handleAuthCallbackPKCE(); } catch(e){ console.error(e); alert("Login failed: "+e.message); }
        this.accessToken = getStoredToken() || await (async()=>{ try{ return await refreshIfNeeded(); }catch{} return null; })();
        if (this.accessToken) await this.bootstrap();
      },
      methods:{
        /* Auth */
        login(){ startLoginPKCE(); },
        logout(){
          localStorage.removeItem("sp_access_token");
          localStorage.removeItem("sp_expires_at");
          localStorage.removeItem("sp_refresh_token");
          this.accessToken=null; this.isPremium=false; this.tracks=[]; this.currentTrackIndex=0; this.isPlaying=false;
        },

        /* Bootstrap */
        async bootstrap(){
          try{
            this.sdkSupported = !!window.AudioContext || !!window.webkitAudioContext;

            const me = await this.apiGET("https://api.spotify.com/v1/me");
            this.isPremium = (me.product === "premium");
            this.playbackNote = "";

            await this.loadTopTracks();

            if (!this.isPremium){
              this.playbackNote = "In-browser playback needs Spotify Premium. Play will open in Spotify.";
              return;
            }
            if (this.isMobile){
              this.playbackNote = "Mobile browsers can’t use the Web Playback SDK. Play will open in Spotify.";
              return;
            }
            if (!this.sdkSupported){
              this.playbackNote = "This browser can’t run Spotify’s Web Playback SDK. Try Chrome/Edge/Firefox on desktop.";
              return;
            }
            await this.setupPlayer();
          }catch(e){
            console.error(e);
            alert("Spotify auth failed or API error. Try reconnecting.");
            this.logout();
          }
        },

        /* Data */
        async loadTopTracks(){
          if (!this.accessToken) return;
          try{ this.accessToken = await refreshIfNeeded() || this.accessToken; }catch{}
          const url = `https://api.spotify.com/v1/me/top/tracks?limit=10&time_range=${this.timeRange}`;
          const data = await this.apiGET(url);
          this.tracks = (data.items || []).map(t => ({
            id: t.id,
            name: t.name,
            artist: (t.artists || []).map(a => a.name).join(", "),
            cover: (t.album?.images?.[0]?.url) || "",
            url: t.external_urls?.spotify || "#",
            uri: t.uri,
            favorited: false
          }));
          this.currentTrackIndex = 0;
          if (this.isPremium && this.deviceId) await this.transferAndQueue(this.currentTrackIndex, false);
        },

        /* Player */
        async setupPlayer(){
          await new Promise(resolve => { if (window.Spotify) resolve(); else window.onSpotifyWebPlaybackSDKReady = resolve; });

          this.player = new Spotify.Player({
            name:"Vinny Top 10 Player",
            getOAuthToken: cb => cb(this.accessToken),
            volume:0.8
          });

          this.player.addListener("ready", async ({device_id})=>{
            this.deviceId = device_id;
            this.playbackNote = "Connected • Web Player ready";
            try{
              await this.apiPUT("https://api.spotify.com/v1/me/player", { device_ids:[device_id], play:false });
              if (this.tracks.length) await this.transferAndQueue(this.currentTrackIndex, false);
            }catch(e){
              console.warn("Transfer failed:", e);
              this.playbackNote = "Connected • Click Play to start";
            }
          });

          this.player.addListener("not_ready", ({device_id})=>{
            if (this.deviceId === device_id) this.deviceId = null;
            this.playbackNote = "Web Player not ready";
          });

          this.player.addListener("player_state_changed", s=>{
            if (!s) return;
            const { position, duration, paused, track_window } = s;
            this.isPlaying = !paused;
            if (duration){
              this.barWidth = `${(position / duration) * 100}%`;
              this.currentTime = this.formatTime(position / 1000);
              this.duration = this.formatTime(duration / 1000);
            }
            const currUri = track_window?.current_track?.uri;
            const idx = this.tracks.findIndex(t => t.uri === currUri);
            if (idx >= 0) this.currentTrackIndex = idx;
          });

          const ok = await this.player.connect();
          if (!ok){ this.playbackNote = "Couldn’t connect the Web Player"; console.warn("Player connection failed"); }
        },

        async togglePlay(){
          if (!this.tracks.length) return;
          const canInline = this.isPremium && !this.isMobile && this.sdkSupported && this.player && this.deviceId;

          if (!canInline){
            if (!this.isPremium) this.playbackNote = "Premium required for in-browser playback.";
            else if (this.isMobile) this.playbackNote = "Mobile browsers can’t use the Web Playback SDK.";
            else if (!this.sdkSupported) this.playbackNote = "This browser can’t run the Web Playback SDK.";
            else if (!this.deviceId) this.playbackNote = "Web Player not ready yet — try again in a sec.";
            window.open(this.currentTrack.url, "_blank");
            return;
          }

          try{
            const state = await this.player.getCurrentState();
            if (!state || state.paused){
              await this.transferAndQueue(this.currentTrackIndex, true);
              this.playbackNote = "Playing on Web Player";
            } else {
              await this.player.togglePlay();
            }
          }catch(e){
            console.error(e);
            this.playbackNote = "Couldn’t start playback. Opening in Spotify.";
            window.open(this.currentTrack.url, "_blank");
          }
        },

        async nextTrack(){
          if (!this.tracks.length) return;
          const next = (this.currentTrackIndex + 1) % this.tracks.length;
          await this.playIndex(next);
        },
        async prevTrack(){
          if (!this.tracks.length) return;
          const prev = (this.currentTrackIndex - 1 + this.tracks.length) % this.tracks.length;
          await this.playIndex(prev);
        },
        async playIndex(index){
          this.currentTrackIndex = index;
          const canInline = this.isPremium && !this.isMobile && this.sdkSupported && this.player && this.deviceId;
          if (!canInline){ window.open(this.tracks[index].url, "_blank"); return; }
          await this.transferAndQueue(index, true);
        },
        async transferAndQueue(index, autoplay){
          const uris = this.tracks.map(t => t.uri);
          await this.apiPUT(`https://api.spotify.com/v1/me/player/play?device_id=${this.deviceId}`, {
            uris, offset:{ position:index }
          });
          if (!autoplay){ try{ await this.player.pause(); }catch{} }
        },
        async seek(e){
          if (!this.player) return;
          const bar = this.$refs.progress.querySelector(".progress__bar");
          const rect = bar.getBoundingClientRect();
          const pct = Math.min(Math.max((e.clientX - rect.left) / rect.width, 0), 1);
          try{
            const state = await this.player.getCurrentState();
            if (state){ const ms = Math.floor(state.duration * pct); await this.player.seek(ms); }
          }catch(err){ console.error(err); }
        },
        toggleFavorite(){
          if (!this.tracks.length) return;
          const t = this.tracks[this.currentTrackIndex];
          t.favorited = !t.favorited;
          this.$set(this.tracks, this.currentTrackIndex, { ...t });
        },
        formatTime(sec){
          const s = Math.floor(sec), m = Math.floor(s/60), r = s%60;
          return `${m}:${r.toString().padStart(2,"0")}`;
        },

        /* HTTP */
        async apiGET(url){
          const r = await fetch(url, { headers:{ Authorization:`Bearer ${this.accessToken}` } });
          if (!r.ok) throw new Error(await r.text());
          return r.json();
        },
        async apiPUT(url, body){
          const r = await fetch(url, {
            method:"PUT",
            headers:{ Authorization:`Bearer ${this.accessToken}`, "Content-Type":"application/json" },
            body: body ? JSON.stringify(body) : null
          });
          if (!r.ok && r.status !== 204) throw new Error(await r.text());
          return true;
        }
      }
    });
  </script>
</body>
</html>
